#!/bin/bash

# clean = white V
# staged = green +
# tracked (modified) = red
# tracked and staged = red
# untracked = ?
# conflict = red background

# ahead/behind = white <>

# colors
RED=$'\033[0;31m'
RED_BG=$'\033[31;7m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[1;33m'
BLUE=$'\033[0;34m'
RST_CLR=$'\033[0m' # Reset Color

# symbols
V="\u2714"
X="\u2716"
PLUS="\u2795"
QUESTION="\u2753"
EXCLAMATION="\u2757"
ARROW_LEFT="\u21B6"
ARROW_RIGHT="\u21B7"
TWO_ARROWS="\u21C5"

# parsed symbols
SYMB_CLEAN="$V"
SYMB_CONFLICT="$X"
SYMB_STAGED="$PLUS"
SYMB_CHANGED="$EXCLAMATION"
SYMB_NEWFILES="$QUESTION"
SYMB_AHEAD="$ARROW_RIGHT"
SYMB_BEHIND="$ARROW_LEFT"
SYMB_DIVERGED="$TWO_ARROWS"

isGitRepository () {
    git rev-parse --is-inside-work-tree >& /dev/null
    echo $?
}

gitBranch () {
    if [ $(isGitRepository) = 0 ] ; then
        local statusText=`git status`
        local branchName=`git rev-parse --abbrev-ref HEAD`
        local branchStatus=""

        if [ $(isClean) = "0" ] ; then
            if [ $(isAhead) = "0" ] ; then
                branchStatus="$SYMB_AHEAD "
            elif [ $(isBehind) = "0" ] ; then
                branchStatus="$SYMB_BEHIND "
            elif [ $(hasDiverged) = "0" ] ; then
                branchStatus="$SYMB_DIVERGED "
            fi

            echo -e "\n$branchName $SYMB_CLEAN $branchStatus"
            return
        fi


        if [ $(hasConflicts) = "0" ] ; then
            echo -e "\n${RED_BG}${branchName} ${SYMB_CONFLICT}${RST_CLR}"
            return
        fi


        if [ $(hasStaged) = "0" ] ; then
            branchStatus="${GREEN}${SYMB_STAGED}${RST_CLR} "
        fi

        if [ $(hasChanges) = "0" ] ; then
            branchStatus="${branchStatus}${RED}${SYMB_CHANGED}${RST_CLR}"
        fi

        if [ $(hasNewFiles) = "0" ] ; then
            branchStatus="${branchStatus}${RED}${SYMB_NEWFILES}${RST_CLR} "
        fi

        echo -e "\n$branchName $branchStatus"
    else
        echo ''
    fi
}

isCleanIndicator="working directory clean"
isClean () {
    _isClean=`echo $statusText | grep -c "$isCleanIndicator"`

    if [ "$_isClean" == "1" ] ; then
        echo 0
    else
        echo 1
    fi
}

isAheadIndicator="branch is ahead"
isAhead () {
    _isAhead=`echo $statusText | grep -c "$isAheadIndicator"`

    if [ "$_isAhead" == "1" ] ; then
        echo 0
    else
        echo 1
    fi
}

isBehindIndicator="branch is behind"
isBehind () {
    _isBehind=`echo $statusText | grep -c "$isBehindIndicator"`

    if [ "$_isBehind" == "1" ] ; then
        echo 0
    else
        echo 1
    fi
}

hasDivergedIndicator="have diverged"
hasDiverged () {
    _hasDiverged=`echo $statusText | grep -c "$hasDivergedIndicator"`

    if [ "$_hasDiverged" == "1" ] ; then
        echo 0
    else
        echo 1
    fi
}

hasStagedIndicator="Changes to be committed"
hasStaged () {
    _hasStaged=`echo $statusText | grep -c "$hasStagedIndicator"`

    if [ "$_hasStaged" == "1" ] ; then
        echo 0
    else
        echo 1
    fi
}

hasChangesIndicator="Changes not staged for commit"
hasChanges () {
    _hasChanges=`echo $statusText | grep -c "$hasChangesIndicator"`

    if [ "$_hasChanges" == "1" ] ; then
        echo 0
    else
        echo 1
    fi
}

hasNewFilesIndicator="Untracked files"
hasNewFiles () {
    _hasNewFiles=`echo $statusText | grep -c "$hasNewFilesIndicator"`

    if [ "$_hasNewFiles" == "1" ] ; then
        echo 0
    else
        echo 1
    fi
}

hasConflictsIndicator="both modified"
hasConflicts () {
    _hasConflicts=`echo $statusText | grep -c "$hasConflictsIndicator"`

    if [ "$_hasConflicts" == "1" ] ; then
        echo 0
    else
        echo 1
    fi
}

export PS1=$'\n\[$BLUE\]\w\[$RST_CLR\]$(gitBranch) \[$YELLOW\]\u27A4\[$RST_CLR\]  '
